import os
import torch
import clip
import requests
from io import BytesIO
from PIL import Image
from supabase import create_client, Client
from dotenv import load_dotenv

# load environment variables - getting secret key and url
print("Script Started") #test print to check if the script runs
load_dotenv()

SUPABASE_URL = os.getenv("VITE_SUPABASE_URL")
SUPABASE_SECRET_KEY = os.getenv("SUPABASE_SECRET_KEY")  # must use service key

if not SUPABASE_URL or not SUPABASE_SECRET_KEY:
    raise ValueError("Missing SUPABASE_URL or SUPABASE_SECRET_KEY in .env")

# create supabase client
supabase: Client = create_client(SUPABASE_URL, SUPABASE_SECRET_KEY)

# load clip model
device = "cuda" if torch.cuda.is_available() else "cpu"
model, preprocess = clip.load("ViT-B/32", device=device)

# encode image function - returns clip embeddings
def encode_image(url: str):
    """Download image and return normalized 512-d CLIP embedding."""
    response = requests.get(url, timeout=10)
    img = Image.open(BytesIO(response.content)).convert("RGB")
    
    img_tensor = preprocess(img).unsqueeze(0).to(device)
    with torch.no_grad():
        embedding = model.encode_image(img_tensor)
    
    # normalize embedding
    embedding = embedding / embedding.norm(dim=-1, keepdim=True)
    return embedding.cpu().numpy()[0].tolist()

# ensure the embedding col exists - creates if not 
# update: (manually altered table schema)
def ensure_embedding_column():
    """Create embedding column if it doesn't exist."""
    sql = "ALTER TABLE clothing_items ADD COLUMN IF NOT EXISTS embedding vector(512);"
    supabase.postgrest.rpc("exec", {"sql": sql})
    print("'embedding' column ensured.")

# main script 
def main():
    print("Starting embedding script")

    # ensure embedding column exists
    ensure_embedding_column()

    # find supabase rows
    print("Fetching clothing_items rows")
    result = supabase.table("clothing_items") \
        .select("clothing_id, image_url, embedding") \
        .execute()

    rows = result.data
    print(f"Found {len(rows)} rows.\n")

    #iterates through rows
    for row in rows:
        item_id = row["clothing_id"]
        image_url = row["image_url"]
        existing_emb = row.get("embedding")

        # skip if embedding exists
        if existing_emb is not None:
            print(f"[SKIP] clothing_id={item_id}: embedding already exists.")
            continue

        print(f"[PROCESS] clothing_id={item_id} â€” {image_url}")

        # encode image
        try:
            embedding = encode_image(image_url)
        except Exception as e:
            print(f"[ERROR] Could not encode clothing_id={item_id}: {e}")
            continue

        # update embedding row
        try:
            supabase.table("clothing_items") \
                .update({"embedding": embedding}) \
                .eq("clothing_id", item_id) \
                .execute()
            print(f"[OK] Stored embedding for clothing_id={item_id}\n")
        except Exception as e:
            print(f"[ERROR] Supabase update failed for clothing_id={item_id}: {e}")

    print("Done generating embeddings!")

# run main
if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print("Script error:", e)
