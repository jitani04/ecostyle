let l=null;function d(){var i,c;const e=window.location.hostname.replace("www.",""),n={"patagonia.com":"Patagonia"};if(n[e])return n[e];const t=window.location.pathname.split("/").filter(Boolean);if(t.length){const s=t[0].replace(/[-_]/g," ");if(s.length>2)return s}const r=(c=(i=document.querySelector("h1"))==null?void 0:i.textContent)==null?void 0:c.trim();if(r)return r;const o=document.title;if(o)return o.split("|")[0].trim();const a=document.querySelector('meta[property="og:site_name"]');return a!=null&&a.content?a.content:null}function u(e){return e.complete&&e.naturalWidth>0&&e.naturalHeight>0?Promise.resolve(e):new Promise((n,t)=>{const r=()=>{a(),e.naturalWidth>0&&e.naturalHeight>0?n(e):t(new Error("Image failed to load"))},o=()=>{a(),t(new Error("Image failed to load"))},a=()=>{e.removeEventListener("load",r),e.removeEventListener("error",o)};e.addEventListener("load",r,{once:!0}),e.addEventListener("error",o,{once:!0})})}function m(e){const n=e.naturalWidth,t=e.naturalHeight;if(!n||!t)throw new Error("Image has no size");const r=document.createElement("canvas");r.width=n,r.height=t;const o=r.getContext("2d");if(!o)throw new Error("Could not access 2D context");return o.drawImage(e,0,0,n,t),r.toDataURL("image/jpeg",.92)}async function f(e){if(!e)throw new Error("Image source missing");const n=await fetch(e,{mode:"cors",credentials:"omit"}).catch(async()=>fetch(e,{mode:"no-cors",credentials:"omit"}));if(!n)throw new Error("Failed to fetch image data");if(!(n.type==="opaque")&&!n.ok)throw new Error("Failed to fetch image data");const r=await n.blob();return new Promise((o,a)=>{const i=new FileReader;i.onload=()=>o(String(i.result)),i.onerror=()=>a(new Error("Failed to convert image")),i.readAsDataURL(r)})}function h(e){var o;if(!(e instanceof Element))return null;if(e instanceof HTMLImageElement)return e;const n=(o=e.closest("picture"))==null?void 0:o.querySelector("img");if(n instanceof HTMLImageElement)return n;const t=e.querySelector("img");if(t instanceof HTMLImageElement)return t;const r=e.closest("img");return r instanceof HTMLImageElement?r:null}function g(){let e=null,n=0;const t=window.innerWidth,r=window.innerHeight;return Array.from(document.images).forEach(o=>{const a=o.getBoundingClientRect();if(!a.width||!a.height||!(a.bottom>0&&a.right>0&&a.top<r&&a.left<t))return;const c=a.width*a.height;c>n&&c>=1e4&&(e=o,n=c)}),e}function w(e){const n=document.getElementById("ecostyle-badge");if(n){n.textContent=`Eco: ${e}`;return}const t=document.createElement("div");t.id="ecostyle-badge",t.textContent=`Eco: ${e}`,t.style.position="fixed",t.style.right="12px",t.style.bottom="12px",t.style.background="rgba(14,165,164,0.95)",t.style.color="white",t.style.padding="6px 10px",t.style.borderRadius="8px",t.style.zIndex="2147483647",t.style.fontFamily="system-ui, -apple-system, Segoe UI, Roboto, sans-serif",document.documentElement.appendChild(t)}async function p(){const e=d();e&&chrome.runtime.sendMessage({type:"GET_BRAND_SCORE",brand:e},n=>{n&&(n.ok?w(String(n.score??"â€”")):console.error("Error getting brand score",n.error))})}p();document.addEventListener("click",e=>{const n=h(e.target);n&&(l=n)},{capture:!0});chrome.runtime.onMessage.addListener((e,n,t)=>(e==null?void 0:e.type)!=="CAPTURE_PRODUCT_IMAGE"?!1:((async()=>{try{const r=l||g();if(!r){t({ok:!1,error:"No product image detected. Click the product image first."});return}await u(r);let o;try{o=m(r)}catch{const i=r.currentSrc||r.src;o=await f(i)}t({ok:!0,imageDataUrl:o,imageSource:r.currentSrc||r.src,width:r.naturalWidth,height:r.naturalHeight})}catch(r){const o=r instanceof Error?r.message:"Failed to capture product image";t({ok:!1,error:o})}})(),!0));
