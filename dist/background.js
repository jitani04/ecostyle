import{c as d}from"./assets/index-m0-2F3vG.js";import"./assets/_commonjsHelpers-C932wzq6.js";const h="https://ijordqbhfxfumbakdsvy.supabase.co",_="sb_publishable_pff029pPjLJsHJmdHRkNNw_NITFbBk_",u=d(h,_);function f(r){if(!r)return null;try{const e=new URL(r);return e.pathname=e.pathname.replace(/\/api\/recommend\/?$/,"/"),e.toString()}catch(e){return console.warn("[background] Failed to derive assets base URL",e),null}}function y(r){const e=r.split(",");if(e.length<2)throw new Error("Malformed data URL");const o=e[0].match(/data:([^;]+);/),n=o?o[1]:"image/jpeg",a=atob(e[1]),c=a.length,l=new Uint8Array(c);for(let i=0;i<c;i+=1)l[i]=a.charCodeAt(i);return{blob:new Blob([l],{type:n}),mime:n}}function m(r,e){return Array.isArray(r)?r.map(t=>{const o=(t==null?void 0:t.image_path)??"";let n=typeof(t==null?void 0:t.image_url)=="string"?t.image_url:"";if(!n&&o){if(/^https?:\/\//i.test(o))n=o;else if(e)try{const a=e.endsWith("/")?e:`${e}/`;n=new URL(o.replace(/^\//,""),a).toString()}catch(a){console.warn("[background] Failed to build image URL for match",a)}}return{...t,image_path:o,image_url:n||o}}):[]}const s="http://localhost:8000/api/recommend",p=s,S=f(void 0)||f(s);async function w(r,e){if(!r.startsWith("data:"))throw new Error("Expected image data URL");const{blob:t,mime:o}=y(r),n=o.split("/")[1]||"jpg",a=new FormData;a.append("file",t,`product.${n}`),typeof e=="number"&&a.append("k",String(e));const c=await fetch(p,{method:"POST",body:a});if(!c.ok){const i=await c.text().catch(()=>"");throw new Error(i||`Recommendation request failed with status ${c.status}`)}const l=await c.json();if(l!=null&&l.error)throw new Error(l.error);return{matches:m(l==null?void 0:l.matches,S)}}console.log("[background] service worker loaded, supabase url:","SET");async function k(r){let{data:e,error:t}=await u.from("brands").select("overall_score").eq("brand_name",r).limit(1).maybeSingle();if(t&&console.error("Supabase error (exact match):",t),!e){const{data:o,error:n}=await u.from("brands").select("brand_name, overall_score").ilike("brand_name",`%${r}%`).limit(1).maybeSingle();if(n)throw console.error("Supabase error (fuzzy):",n),n;return(o==null?void 0:o.overall_score)??null}return e.overall_score??null}async function E(r){try{let{data:e,error:t}=await u.from("brands").select("brand_name, overall_score").eq("brand_url",r).limit(1).maybeSingle();if(t&&console.error("[supabase] exact url query error",t),e)return{brand:e.brand_name,score:e.overall_score};try{const o=new URL(r),n=o.origin,{data:a,error:c}=await u.from("brands").select("brand_name, overall_score").eq("brand_url",n).limit(1).maybeSingle();if(c&&console.error("[supabase] origin query error",c),a)return{brand:a.brand_name,score:a.overall_score};const l=o.hostname,{data:i,error:b}=await u.from("brands").select("brand_name, overall_score").ilike("brand_url",`%${l}%`).limit(1).maybeSingle();if(b&&console.error("[supabase] fuzzy url query error",b),i)return{brand:i.brand_name,score:i.overall_score}}catch(o){console.warn("[background] invalid URL for url matching",r,o)}return{brand:null,score:null}}catch(e){throw console.error("[background] queryOverallScoreByUrl exception",e),e}}async function g(){const{data:r,error:e}=await u.from("brands").select("*");return e?(console.error("Supabase query error:",e),[]):r}async function v(r){const e=await g(),t=e.find(a=>{try{return r.includes(new URL(a.brand_url).hostname)}catch{return!1}}),o=t==null?void 0:t.price_tier,n=e.filter(a=>a.overall_score>=60).filter(a=>o?a.price_tier===o:!0).sort((a,c)=>c.overall_score-a.overall_score).slice(0,5);return{currentBrand:t,recommendations:n}}chrome.runtime.onMessage.addListener((r,e,t)=>{try{if(console.log("[background] received message",r,"from",(e==null?void 0:e.id)||(e==null?void 0:e.origin)||e),(r==null?void 0:r.type)==="GET_BRAND_SCORE"&&r.brand)return k(r.brand).then(o=>{console.log("[background] queryOverallScore result for",r.brand,o),t({ok:!0,score:o})}).catch(o=>{console.error("[background] queryOverallScore error",o),t({ok:!1,error:String(o)})}),!0;if((r==null?void 0:r.type)==="GET_BRAND_SCORE_BY_URL"&&r.url)return E(r.url).then(o=>{console.log("[background] queryOverallScoreByUrl result for",r.url,o),t({ok:!0,brand:o.brand,score:o.score})}).catch(o=>{console.error("[background] queryOverallScoreByUrl error",o),t({ok:!1,error:String(o)})}),!0;if(r.type==="GET_RECOMMENDED_BRANDS"&&r.hostname)return v(r.hostname).then(o=>t({ok:!0,...o})).catch(o=>t({ok:!1,error:String(o)})),!0;if((r==null?void 0:r.type)==="GET_SIMILAR_ITEMS"&&typeof r.imageDataUrl=="string"){const o=typeof r.k=="number"?r.k:Number.parseInt(r.k,10);return w(r.imageDataUrl,Number.isFinite(o)?o:void 0).then(n=>{t({ok:!0,...n})}).catch(n=>{console.error("[background] requestSimilarItems error",n),t({ok:!1,error:String(n instanceof Error?n.message:n)})}),!0}}catch(o){if(console.error("[background] onMessage handler exception",o),typeof t=="function")try{t({ok:!1,error:String(o)})}catch(n){console.warn("[background] failed to send error response",n)}}return!1});
